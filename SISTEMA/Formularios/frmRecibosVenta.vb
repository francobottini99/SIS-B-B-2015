Public Class frmRecibosVenta
    Private Sub btnNuevo_GotFocus(sender As Object, e As EventArgs) Handles btnNuevo.GotFocus
        btnNuevo.BackgroundImage = ByB_SI.My.Resources.NuevoAc
    End Sub

    Private Sub btnNuevo_LostFocus(sender As Object, e As EventArgs) Handles btnNuevo.LostFocus
        btnNuevo.BackgroundImage = ByB_SI.My.Resources.NuevoIn
    End Sub

    Private Sub btnNuevo_MouseEnter(sender As Object, e As EventArgs) Handles btnNuevo.MouseEnter
        btnNuevo.BackgroundImage = ByB_SI.My.Resources.NuevoAc
    End Sub

    Private Sub btnNuevo_MouseLeave(sender As Object, e As EventArgs) Handles btnNuevo.MouseLeave
        btnNuevo.BackgroundImage = ByB_SI.My.Resources.NuevoIn
    End Sub

    Private Sub btnGuardar_GotFocus(sender As Object, e As EventArgs) Handles btnGuardar.GotFocus
        btnGuardar.BackgroundImage = ByB_SI.My.Resources.GuardarAc
    End Sub

    Private Sub btnGuardar_LostFocus(sender As Object, e As EventArgs) Handles btnGuardar.LostFocus
        btnGuardar.BackgroundImage = ByB_SI.My.Resources.GuardarIn
    End Sub

    Private Sub btnGuardar_MouseEnter(sender As Object, e As EventArgs) Handles btnGuardar.MouseEnter
        btnGuardar.BackgroundImage = ByB_SI.My.Resources.GuardarAc
    End Sub

    Private Sub btnGuardar_MouseLeave(sender As Object, e As EventArgs) Handles btnGuardar.MouseLeave
        btnGuardar.BackgroundImage = ByB_SI.My.Resources.GuardarIn
    End Sub

    Private Sub btnCancelar_GotFocus(sender As Object, e As EventArgs) Handles btnCancelar.GotFocus
        btnCancelar.BackgroundImage = ByB_SI.My.Resources.CancelarAc
    End Sub

    Private Sub btnCancelar_LostFocus(sender As Object, e As EventArgs) Handles btnCancelar.LostFocus
        btnCancelar.BackgroundImage = ByB_SI.My.Resources.CancelarIn
    End Sub

    Private Sub btnCancelar_MouseEnter(sender As Object, e As EventArgs) Handles btnCancelar.MouseEnter
        btnCancelar.BackgroundImage = ByB_SI.My.Resources.CancelarAc
    End Sub

    Private Sub btnCancelar_MouseLeave(sender As Object, e As EventArgs) Handles btnCancelar.MouseLeave
        btnCancelar.BackgroundImage = ByB_SI.My.Resources.CancelarIn
    End Sub

    Private Sub btnSalir_GotFocus(sender As Object, e As EventArgs) Handles btnSalir.GotFocus
        btnSalir.BackgroundImage = ByB_SI.My.Resources.SalirAc
    End Sub

    Private Sub btnSalir_LostFocus(sender As Object, e As EventArgs) Handles btnSalir.LostFocus
        btnSalir.BackgroundImage = ByB_SI.My.Resources.SalirIn
    End Sub

    Private Sub btnSalir_MouseEnter(sender As Object, e As EventArgs) Handles btnSalir.MouseEnter
        btnSalir.BackgroundImage = ByB_SI.My.Resources.SalirAc
    End Sub

    Private Sub btnSalir_MouseLeave(sender As Object, e As EventArgs) Handles btnSalir.MouseLeave
        btnSalir.BackgroundImage = ByB_SI.My.Resources.SalirIn
    End Sub

    Private Sub btnEliminar_GotFocus(sender As Object, e As EventArgs) Handles btnEliminarValor.GotFocus
        btnEliminarValor.BackgroundImage = ByB_SI.My.Resources.EliminarAc
    End Sub

    Private Sub btnEliminar_LostFocus(sender As Object, e As EventArgs) Handles btnEliminarValor.LostFocus
        btnEliminarValor.BackgroundImage = ByB_SI.My.Resources.EliminarIn
    End Sub

    Private Sub btnEliminar_MouseEnter(sender As Object, e As EventArgs) Handles btnEliminarValor.MouseEnter
        btnEliminarValor.BackgroundImage = ByB_SI.My.Resources.EliminarAc
    End Sub

    Private Sub btnEliminar_MouseLeave(sender As Object, e As EventArgs) Handles btnEliminarValor.MouseLeave
        btnEliminarValor.BackgroundImage = ByB_SI.My.Resources.EliminarIn
    End Sub

    Private Sub btnCargarValor_GotFocus(sender As Object, e As EventArgs) Handles btnCargarValor.GotFocus
        btnCargarValor.BackgroundImage = ByB_SI.My.Resources.IngresoAc
    End Sub

    Private Sub btnCargarValor_LostFocus(sender As Object, e As EventArgs) Handles btnCargarValor.LostFocus
        btnCargarValor.BackgroundImage = ByB_SI.My.Resources.IngresoIn
    End Sub

    Private Sub btnCargarValor_MouseEnter(sender As Object, e As EventArgs) Handles btnCargarValor.MouseEnter
        btnCargarValor.BackgroundImage = ByB_SI.My.Resources.IngresoAc
    End Sub

    Private Sub btnCargarValor_MouseLeave(sender As Object, e As EventArgs) Handles btnCargarValor.MouseLeave
        btnCargarValor.BackgroundImage = ByB_SI.My.Resources.IngresoIn
    End Sub

    Private Sub btnModValor_GotFocus(sender As Object, e As EventArgs) Handles btnModValor.GotFocus
        btnModValor.BackgroundImage = ByB_SI.My.Resources.ModifAc
    End Sub

    Private Sub btnModValor_LostFocus(sender As Object, e As EventArgs) Handles btnModValor.LostFocus
        btnModValor.BackgroundImage = ByB_SI.My.Resources.ModifIn
    End Sub

    Private Sub btnModValor_MouseEnter(sender As Object, e As EventArgs) Handles btnModValor.MouseEnter
        btnModValor.BackgroundImage = ByB_SI.My.Resources.ModifAc
    End Sub

    Private Sub btnModValor_MouseLeave(sender As Object, e As EventArgs) Handles btnModValor.MouseLeave
        btnModValor.BackgroundImage = ByB_SI.My.Resources.ModifIn
    End Sub

    Private Sub btnCancelarValor_GotFocus(sender As Object, e As EventArgs) Handles btnCancelarValor.GotFocus
        btnCancelarValor.BackgroundImage = ByB_SI.My.Resources.CancelarAc
    End Sub

    Private Sub btnCancelarValor_LostFocus(sender As Object, e As EventArgs) Handles btnCancelarValor.LostFocus
        btnCancelarValor.BackgroundImage = ByB_SI.My.Resources.CancelarIn
    End Sub

    Private Sub btnCancelarValor_MouseEnter(sender As Object, e As EventArgs) Handles btnCancelarValor.MouseEnter
        btnCancelarValor.BackgroundImage = ByB_SI.My.Resources.CancelarAc
    End Sub

    Private Sub btnCancelarValor_MouseLeave(sender As Object, e As EventArgs) Handles btnCancelarValor.MouseLeave
        btnCancelarValor.BackgroundImage = ByB_SI.My.Resources.CancelarIn
    End Sub

    Private Sub btnSalir_Click(sender As Object, e As EventArgs) Handles btnSalir.Click
        Dim _Elim As New GrabaDatos
        If dgvBufDetalle.RowCount <> 0 Then
            Dim resP As DialogResult
            resP = MessageBox.Show("Salir y vaciar contenido del detalle de valores ?", "Servico de Alertas", MessageBoxButtons.OKCancel, MessageBoxIcon.Question)

            If resP = Windows.Forms.DialogResult.OK Then
                _Elim.Grabar("Recibo Venta", "NoImagen", "vaciaVentaRecDetalleBuf")
                gbxDatos.Enabled = False
                btnNuevo.Enabled = True
                btnCancelar.Enabled = False
                btnGuardar.Enabled = False
                btnNuevo.Select()
                Limpiar()
                Me.Hide()
            End If
        Else
            gbxDatos.Enabled = False
            btnNuevo.Enabled = True
            btnCancelar.Enabled = False
            btnGuardar.Enabled = False
            btnNuevo.Select()
            Limpiar()
            Me.Hide()
        End If
    End Sub

    Private Sub txtIdCli_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtIdCli.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            If txtIdCli.Text = "" Then
                e.Handled = True
                frmClientes.lblOrigen.Text = "Recibo Venta"
                frmClientes.txtBuscar.Text = ""
                frmClientes.txtBuscar.Select()
                frmClientes.ShowDialog()
            Else
                e.Handled = True
                If IsNumeric(txtIdCli.Text) Then
                    If CDbl(txtIdCli.Text) = 0 Then
                        txtCliente.Select()
                    Else
                        Dim _Ver As New Mostrar
                        Dim _Ds As New DataSet
                        _Ds.Tables.Add(_Ver.verClientes(mdifrmppal.cdEmp).Copy)
                        Dim _Dv As New DataView(_Ds.Tables(0))
                        _Dv.RowFilter = "IdClientes = " & CInt(txtIdCli.Text)
                        If _Dv.Count <> 0 Then
                            dgvCliente.DataSource = _Dv
                            dgvCliente.Select()
                            txtCliente.Text = dgvCliente.SelectedCells.Item(4).Value
                            txtImporte.SelectionLength = Len(txtImporte.Text)
                            txtImporte.Select()
                        Else
                            MsgBox("Error: Nro de Cuenta no se corresponde con ningún cliente !", vbInformation, "Servicio de Alertas")
                            txtCliente.Text = ""
                            txtIdCli.Text = ""
                            txtIdCli.Select()
                        End If
                    End If
                End If
            End If
        End If
    End Sub

    Private Sub btnNuevo_Click(sender As Object, e As EventArgs) Handles btnNuevo.Click
        gbxDatos.Enabled = True
        gbxDetalle.Enabled = True
        Limpiar()
        txtCdEmp.Text = mdifrmppal.cdEmp
        txtFecAlta.Text = Date.Now.Date
        txtHora.Text = Date.Now.ToString("HH:mm:ss")
        txtImporte.Text = Format(0, "$ #,##0.00")
        txtImpValor.Text = Format(0, "$ #,##0.00")
        btnNuevo.Enabled = False
        btnCancelar.Enabled = True
        btnGuardar.Enabled = True
        cbxTipoMov.Select()
        lblFuncion.Text = "Nuevo"
        lblFunValor.Text = "Nuevo"
    End Sub

    Private Sub Limpiar()
        txtCdEmp.Text = ""
        txtFecAlta.Text = ""
        txtHora.Text = ""
        cbxTipoMov.Text = ""
        txtIdCli.Text = ""
        txtCliente.Text = ""
        txtObserv.Text = ""
        txtValNum.Text = ""
        cbxTipoValor.Text = ""
        cbxBanco.Text = ""
        txtSucursal.Text = ""
        txtFecCobro.Text = ""
        txtImpValor.Text = ""
        txtObsValor.Text = ""
        txtValNum.Text = ""
        cbxTipoValor.Text = ""
        cbxBanco.Text = ""
        txtSucursal.Text = ""
        txtLibrador.Text = ""
        txtFecCobro.Text = ""
        txtObsValor.Text = ""
        txtImpTexto.Text = ""
        txtImporte.Text = Format(0, "$ #,##0.00")
        txtImpValor.Text = Format(0, "$ #,##0.00")
        txtTotVal.Text = Format(0, "$ #,##0.00")
    End Sub

    Private Sub LimpiarValor()
        txtValNum.Text = ""
        cbxTipoValor.Text = ""
        cbxBanco.Text = ""
        txtSucursal.Text = ""
        txtLibrador.Text = ""
        txtImpValor.Text = Format(0, "$ #,##0.00")
        txtFecCobro.Text = ""
        txtObsValor.Text = ""
        txtValNum.Select()
    End Sub

    Private Sub tmrHora_Tick(sender As Object, e As EventArgs) Handles tmrHora.Tick
        If gbxDatos.Enabled = True Then
            txtHora.Text = Date.Now.ToString("HH:mm:ss")
        End If
    End Sub

    Private Sub btnCancelar_Click(sender As Object, e As EventArgs) Handles btnCancelar.Click
        gbxDatos.Enabled = False
        Limpiar()
        btnNuevo.Enabled = True
        btnCancelar.Enabled = False
        btnGuardar.Enabled = False
        btnNuevo.Select()
    End Sub

    Private Sub cbxTipoMov_KeyPress(sender As Object, e As KeyPressEventArgs) Handles cbxTipoMov.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            txtIdCli.SelectionLength = Len(txtIdCli.Text)
            txtIdCli.Select()
        End If
    End Sub

    Private Sub txtCliente_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtCliente.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            txtImporte.SelectionLength = Len(txtImporte.Text)
            txtImporte.Select()
        End If
    End Sub

    Private Sub txtImporte_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtImporte.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            If Not IsNumeric(txtImporte.Text) Then
                txtImporte.Text = Format(0, "$ #,##0.00")
                txtImporte.Select()
            Else
                txtImporte.Text = Format(CDbl(txtImporte.Text), "$ #,##0.00")
                txtObserv.SelectionLength = Len(txtObserv.Text)
                txtObserv.Select()
            End If
        End If
    End Sub

    Private Sub txtObserv_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtObserv.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            txtImpTexto.SelectionLength = Len(txtImpTexto.Text)
            txtImpTexto.Select()
        End If
    End Sub

    Private Sub cbxTipoValor_KeyPress(sender As Object, e As KeyPressEventArgs) Handles cbxTipoValor.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            cbxBanco.SelectionLength = Len(cbxBanco.Text)
            cbxBanco.Select()
        End If
    End Sub

    Private Sub cbxBanco_KeyPress(sender As Object, e As KeyPressEventArgs) Handles cbxBanco.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            txtSucursal.SelectionLength = Len(txtSucursal.Text)
            txtSucursal.Select()
        End If
    End Sub

    Private Sub txtSucursal_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtSucursal.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            txtLibrador.SelectionLength = Len(txtLibrador.Text)
            txtLibrador.Select()
        End If
    End Sub

    Private Sub txtFecCobro_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtFecCobro.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            txtImpValor.SelectionLength = Len(txtImpValor.Text)
            txtImpValor.Select()
        End If
    End Sub

    Private Sub txtFecCobro_Validated(sender As Object, e As EventArgs) Handles txtFecCobro.Validated
        If Not txtFecCobro.Text = "" Then
            If Not IsDate(txtFecCobro.Text) Then
                MsgBox("Error: Formato de Fecha incorrecto.", vbInformation, "Servico de Alertas")
                txtFecCobro.Text = ""
                txtFecCobro.Select()
            Else
                txtFecCobro.Text = Format(CDate(txtFecCobro.Text), "dd/MM/yyyy")
            End If
        End If
    End Sub

    Private Sub txtImpValor_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtImpValor.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            If Not IsNumeric(txtImporte.Text) Then
                txtImpValor.Text = Format(0, "$ #,##0.00")
                txtImpValor.Select()
            Else
                Dim totImp As Double
                If lblFunValor.Text = "Nuevo" Then
                    totImp = CDbl(txtTotVal.Text) + CDbl(txtImpValor.Text)
                    If totImp > CDbl(txtImporte.Text) Then
                        MsgBox("Error: El importe Total de valores cargados es mayor que el importe declarado en el ingreso de caja !", vbInformation, "Servico de Alertas")
                        txtImpValor.Text = Format(0, "$ #,##0.00")
                        txtImpValor.SelectionLength = Len(txtImpValor.Text)
                        txtImpValor.Select()
                    Else
                        txtImpValor.Text = Format(CDbl(txtImpValor.Text), "$ #,##0.00")
                        txtObsValor.SelectionLength = Len(txtObsValor.Text)
                        txtObsValor.Select()
                    End If
                Else
                    txtImpValor.Text = Format(CDbl(txtImpValor.Text), "$ #,##0.00")
                    txtObsValor.SelectionLength = Len(txtObsValor.Text)
                    txtObsValor.Select()
                End If
            End If
        End If
    End Sub

    Private Sub txtObsValor_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtObsValor.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            btnCargarValor.Select()
        End If
    End Sub

    Private Sub txtValNum_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtValNum.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            cbxTipoValor.SelectionLength = Len(cbxTipoValor.Text)
            cbxTipoValor.Select()
        End If
    End Sub

    Private Sub btnGuardar_Click(sender As Object, e As EventArgs) Handles btnGuardar.Click
        Dim resP As DialogResult
        Dim _Guardar As New GrabaDatos

        If cbxTipoMov.Text = "" Then
            MsgBox("Error: Falta detallar Tipo de Movimiento !", vbInformation, "Servico de Alertas")
            cbxTipoMov.Select()
        Else
            If cbxTipoMov.Text = "Ingreso" And txtCliente.Text = "" Then
                MsgBox("Error: No ha especificado un cliente !", vbInformation, "Servico de Alertas")
                txtCliente.Select()
            Else
                If txtImpTexto.Text = "" Then
                    MsgBox("Error: Debe ingresar importe en letras !", vbInformation, "Servico de Alertas")
                    txtImpTexto.Select()
                Else
                    If Not CDbl(txtImporte.Text) > 0 Then
                        MsgBox("Error: El importe del movimiento debe ser mayor que cero !", vbInformation, "Servico de Alertas")
                        txtImporte.SelectionLength = Len(txtImporte.Text)
                        txtImporte.Select()
                    Else
                        If dgvBufDetalle.RowCount = 0 Then
                            MsgBox("Error: No hay valores ingresados !", vbInformation, "Servico de Alertas")
                            txtValNum.Select()
                        Else
                            If CDbl(txtImporte.Text) <> CDbl(txtTotVal.Text) Then
                                MsgBox("Error: El importe del movimiento debe coincidir con el importe total de valores cargados !", vbInformation, "Servico de Alertas")
                                txtValNum.Select()
                            Else
                                resP = MessageBox.Show("Emite Recibo De Venta ?", "Servico de Alertas", MessageBoxButtons.OKCancel, MessageBoxIcon.Question)

                                If resP = Windows.Forms.DialogResult.OK Then
                                    Try
                                        'CUENTA CORRIENTE VENTA
                                        Dim cdBar As String
                                        Dim cdCom As String
                                        cdBar = "*" & txtNroRecibo.Text & Mid(txtFecAlta.Text, 1, 2) & Mid(txtFecAlta.Text, 4, 2) & Mid(txtFecAlta.Text, 7, 4) & "*"
                                        If cbxTipoMov.Text = "Recibo Oficial" Then
                                            cdCom = "04"
                                        Else
                                            cdCom = "00"
                                        End If

                                        'Obtener saldo de Cuenta Corriente de Venta
                                        Dim ulTid As Integer
                                        Dim _VerMax As New Mostrar
                                        Dim _DtMax As New DataTable
                                        Dim saldoCta As Double
                                        _DtMax = _VerMax.verMaxIdVentaCtaCte()

                                        Dim _Row As DataRow = _DtMax.Rows(_DtMax.Rows.Count - 1)
                                        If _Row("UltimoId").ToString = "" Then
                                            ulTid = 0
                                            saldoCta = 0
                                        Else
                                            ulTid = _Row("UltimoId")
                                            _DtMax = _VerMax.consCtaCteVentaID(ulTid)
                                            dgvCtaCte.DataSource = _DtMax
                                            saldoCta = CDbl(dgvCtaCte.SelectedCells.Item(12).Value)
                                        End If

                                        saldoCta = saldoCta - CDbl(txtImporte.Text)
                                        _Guardar.Grabar("Recibo Venta", "NoImagen", "insCtaCteVenta", txtCdEmp.Text, cdBar, Format(CDate(txtFecAlta.Text), "yyyy/MM/dd"), _
                                                        "Contado", "Rc", cbxTipoMov.Text, cdCom, txtPtoVta.Text, txtNroRecibo.Text, 0, CDbl(txtImporte.Text), saldoCta, mdifrmppal.usSis, CInt(txtIdCli.Text))

                                        'Obtener ultimo ID cargado de Factura de Venta
                                        _DtMax = _VerMax.verMaxIdVentaCtaCte()
                                        _Row = _DtMax.Rows(_DtMax.Rows.Count - 1)
                                        ulTid = _Row("UltimoId")

                                        'Grabo Recibo de Venta
                                        cdBar = "*" & txtNroRecibo.Text & txtIdCli.Text & "*"
                                        _Guardar.Grabar("Recibo Venta", "NoImagen", "insRecVenta", txtCdEmp.Text, cdBar, _
                                                        Format(CDate(txtFecAlta.Text), "yyyy/MM/dd"), txtNroRecibo.Text, _
                                                        cbxTipoMov.Text, CDbl(txtImporte.Text), txtImpTexto.Text, txtObserv.Text,
                                                        mdifrmppal.usSis, ulTid)

                                        _DtMax = _VerMax.verMaxIdReciboVta()
                                        Dim _Row3 As DataRow = _DtMax.Rows(_DtMax.Rows.Count - 1)
                                        ulTid = _Row3("UltimoId")

                                        'Grabo detalle de valores cargados
                                        For Each row As DataGridViewRow In dgvBufDetalle.Rows
                                            _Guardar.Grabar("Detalle Recibo Vta", "NoImagen", "insDetalleRecVta", row.Cells(2).Value, _
                                                                Val(row.Cells(3).Value), Format(CDate(row.Cells(4).Value), "yyyy/MM/dd"), _
                                                                row.Cells(5).Value, row.Cells(6).Value, row.Cells(7).Value, _
                                                                CDbl(Val(row.Cells(8).Value)), row.Cells(9).Value, ulTid)
                                        Next

                                        'Obtener saldo de caja del día actual
                                        Dim idCj As Integer
                                        Dim saldoCj As Double
                                        _DtMax = _VerMax.verMaxIdCaja()
                                        Dim _Row1 As DataRow = _DtMax.Rows(_DtMax.Rows.Count - 1)
                                        If _Row1("UltimoId").ToString = "" Then
                                            idCj = 0
                                        Else
                                            idCj = _Row1("UltimoId")
                                        End If
                                        _DtMax = _VerMax.verSaldoCajaUltimoId(idCj)
                                        dgvCaja.DataSource = _DtMax
                                        saldoCj = Format(CDbl(dgvCaja.SelectedCells.Item(10).Value), "$ #,##0.00")
                                        saldoCj = saldoCj + CDbl(txtImporte.Text)

                                        'Grabar caja
                                        Dim recV As String
                                        recV = "Recibo N° " & txtPtoVta.Text & "-" & txtNroRecibo.Text
                                        _Guardar.Grabar("Caja", "NoImagen", "insCaja", txtCdEmp.Text, Format(CDate(txtFecAlta.Text), "yyyy/MM/dd"), _
                                                        cbxTipoMov.Text, CInt(txtIdCli.Text), txtCliente.Text, recV, CDbl(txtImporte.Text), 0, _
                                                        saldoCj, txtObserv.Text, mdifrmppal.usSis)

                                        'Obtener ultimo ID cargado de Caja
                                        _DtMax = _VerMax.verMaxIdCaja()
                                        Dim _Row2 As DataRow = _DtMax.Rows(_DtMax.Rows.Count - 1)
                                        ulTid = _Row2("UltimoId")

                                        Dim enCart As String = ""
                                        For Each row As DataGridViewRow In dgvBufDetalle.Rows
                                            'Grabo Detalle de Movimiento
                                            If row.Cells(2).Value = "Cheque" Then
                                                enCart = "Si"
                                            Else
                                                enCart = "--"
                                            End If
                                            _Guardar.Grabar("Detalle Caja", "NoImagen", "insDetalleCaja", row.Cells(2).Value, _
                                                                Val(row.Cells(3).Value), Format(CDate(row.Cells(4).Value), "yyyy/MM/dd"), _
                                                                row.Cells(5).Value, row.Cells(6).Value, row.Cells(7).Value, _
                                                                CDbl(Val(row.Cells(8).Value)), enCart, row.Cells(9).Value, ulTid)
                                        Next

                                        'Limpio datagrid y pantalla
                                        Dim _Ver As New Mostrar
                                        Dim _Dt As New DataTable
                                        Dim _Elim As New GrabaDatos
                                        _Elim.Grabar("Detalle Recibo Vta", "NoImagen", "vaciaDetalleReciboVta")

                                        _Dt = _Ver.verDetalleValoresRecVta()
                                        dgvBufDetalle.DataSource = _Dt
                                        dgvBufDetalle.Columns.Item("ObservValor").Visible = False

                                        'ACTUALIZO NUMERO RECIBO
                                        Dim X, _inC, _Dig As Integer
                                        Dim _reSto As String

                                        For X = 1 To 8
                                            If Mid(txtNroRecibo.Text, X, 1) <> "0" Then
                                                _Dig = 9 - X
                                                Exit For
                                            End If
                                        Next
                                        _inC = Mid(txtNroRecibo.Text, 9 - _Dig, _Dig)
                                        _inC = _inC + 1
                                        _Dig = Len(CStr(_inC))
                                        _reSto = Mid(txtNroRecibo.Text, 1, 8 - _Dig)
                                        txtNroRecibo.Text = _reSto & CStr(_inC)
                                        _Guardar.Grabar("Recibo Venta", "NoImagen", "modSistemaNroReciboVta", txtCdEmp.Text, txtNroRecibo.Text)

                                        Dim estiloEnc As New DataGridViewCellStyle()
                                        Dim textEnc As String = ""

                                        estiloEnc.Font = New Font(dgvBufDetalle.Font, FontStyle.Bold)
                                        dgvBufDetalle.ColumnHeadersDefaultCellStyle = estiloEnc
                                        dgvBufDetalle.ColumnHeadersDefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                                        For X = 1 To 9
                                            If X = 1 Then
                                                dgvBufDetalle.Columns(X).DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                                            ElseIf X = 4 Then
                                                dgvBufDetalle.Columns(X).DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                                            ElseIf X = 8 Then
                                                dgvBufDetalle.Columns(X).DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                                                dgvBufDetalle.Columns(X).DefaultCellStyle.Format = "$ #,##0.00"
                                            Else
                                                dgvBufDetalle.Columns(X).DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleLeft
                                            End If
                                            Select Case X
                                                Case 0
                                                    textEnc = "ELIM"
                                                    dgvBufDetalle.Columns(0).Width = 30
                                                Case 1
                                                    textEnc = "ITEM"
                                                    dgvBufDetalle.Columns(1).Width = 30
                                                Case 2
                                                    textEnc = "VALOR"
                                                    dgvBufDetalle.Columns(2).Width = 100
                                                Case 3
                                                    textEnc = "NUMERO"
                                                    dgvBufDetalle.Columns(3).Width = 100
                                                Case 4
                                                    textEnc = "FEC COBRO"
                                                    dgvBufDetalle.Columns(4).Width = 150
                                                Case 5
                                                    textEnc = "LIBRADOR"
                                                    dgvBufDetalle.Columns(5).Width = 150
                                                Case 6
                                                    textEnc = "BANCO"
                                                    dgvBufDetalle.Columns(6).Width = 100
                                                Case 7
                                                    textEnc = "SUCURSAL"
                                                    dgvBufDetalle.Columns(7).Width = 100
                                                Case 8
                                                    textEnc = "IMPORTE"
                                                    dgvBufDetalle.Columns(8).Width = 70
                                                Case 9
                                                    textEnc = "OBSERVACIONES"
                                                    dgvBufDetalle.Columns(9).Width = 100
                                            End Select
                                            dgvBufDetalle.Columns(X).HeaderText = textEnc
                                        Next

                                        Limpiar()
                                        gbxDatos.Enabled = False
                                        gbxDetalle.Enabled = False
                                        lblFuncion.Text = "Nuevo"
                                        lblFunValor.Text = "Nuevo"
                                        btnNuevo.Enabled = True
                                        btnGuardar.Enabled = False
                                        btnCancelar.Enabled = False
                                        txtIdCli.Enabled = True
                                        txtCliente.Enabled = True
                                        btnNuevo.Select()
                                    Catch ex As MySqlException
                                        MsgBox("Error: Recibo de Venta No fue Registrado correctamente !" & vbCrLf & vbCrLf & ex.ToString, vbCritical, "Servicio de Alertas")
                                    End Try
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
    End Sub

    Private Sub btnCargarValor_Click(sender As Object, e As EventArgs) Handles btnCargarValor.Click
        Dim _Guardar As New GrabaDatos

        Try
            If cbxTipoValor.Text = "" Then
                MsgBox("Error: Seleccione un Tipo de Valor !", vbInformation, "Servico de Alertas")
                cbxTipoValor.Select()
            Else
                If Not (cbxTipoValor.Text = "Efectivo" Or cbxTipoValor.Text = "Cheque" Or cbxTipoValor.Text = "Tarjeta Crédito" Or cbxTipoValor.Text = "Tarjeta Débito" Or cbxTipoValor.Text = "Otros") Then
                    MsgBox("Error: El Tipo de Valor No es válido!", vbInformation, "Servico de Alertas")
                    cbxTipoValor.Select()
                Else
                    If cbxTipoValor.Text <> "Efectivo" Then
                        If txtValNum.Text = "" Or cbxBanco.Text = "" Or txtSucursal.Text = "" Or txtLibrador.Text = "" Or txtFecCobro.Text = "" Or CDbl(txtImpValor.Text) = 0 Then
                            MsgBox("Error: Todos los campos (menos Observaciones) son obligatorios, importe no pude ser cero !", vbInformation, "Servico de Alertas")
                        Else
                            If lblFunValor.Text = "Nuevo" Then
                                _Guardar.Grabar("Recibo Vta", "NoImagen", "insBufferDetalleRecVta", cbxTipoValor.Text, txtValNum.Text, _
                                                Format(CDate(txtFecCobro.Text), "yyyy/MM/dd"), txtLibrador.Text, cbxBanco.Text, _
                                                txtSucursal.Text, CDbl(txtImpValor.Text), txtObsValor.Text)
                            Else
                                _Guardar.Grabar("Recibo Vta", "NoImagen", "modBufferDetalleRecVta", lblidDetCaja.Text, cbxTipoValor.Text, txtValNum.Text, _
                                                Format(CDate(txtFecCobro.Text), "yyyy/MM/dd"), txtLibrador.Text, cbxBanco.Text, _
                                                txtSucursal.Text, CDbl(txtImpValor.Text), txtObsValor.Text)
                            End If
                            LimpiarValor()
                            ActualizaTotal()
                            lblFunValor.Text = "Nuevo"
                            txtValNum.Select()
                        End If
                    Else
                        If CDbl(txtImpValor.Text) = 0 Then
                            MsgBox("Error: El importe NO puede ser cero !", vbInformation, "Servico de Alertas")
                            txtImpValor.Select()
                        Else
                            If txtObsValor.Text = "" Then
                                txtObsValor.Text = "-"
                            End If

                            If lblFunValor.Text = "Nuevo" Then
                                _Guardar.Grabar("Recibo Vta", "NoImagen", "insBufferDetalleRecVta", cbxTipoValor.Text, "-99", _
                                                Format(Date.Now.Date, "yyyy/MM/dd"), "-", "-", _
                                                "-", CDbl(txtImpValor.Text), txtObsValor.Text)
                            Else
                                _Guardar.Grabar("Recibo Vta", "NoImagen", "modBufferDetalleRecVta", lblidDetCaja.Text, cbxTipoValor.Text, "-99", _
                                                Format(Date.Now.Date, "yyyy/MM/dd"), "-", "-", _
                                                "-", CDbl(txtImpValor.Text), txtObsValor.Text)
                            End If
                            LimpiarValor()
                            ActualizaTotal()
                            lblFunValor.Text = "Nuevo"
                            txtValNum.Select()
                        End If
                    End If

                    Dim _Dt As New DataTable
                    Dim _Ver As New Mostrar
                    _Dt = _Ver.verDetalleValoresRecVta()
                    dgvBufDetalle.DataSource = _Dt
                    dgvBufDetalle.Columns.Item("ObservValor").Visible = False

                    Dim estiloEnc As New DataGridViewCellStyle()
                    Dim textEnc As String = ""
                    Dim X As Integer

                    estiloEnc.Font = New Font(dgvBufDetalle.Font, FontStyle.Bold)
                    dgvBufDetalle.ColumnHeadersDefaultCellStyle = estiloEnc
                    dgvBufDetalle.ColumnHeadersDefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                    For X = 1 To 9
                        If X = 1 Then
                            dgvBufDetalle.Columns(X).DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                        ElseIf X = 4 Then
                            dgvBufDetalle.Columns(X).DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                        ElseIf X = 8 Then
                            dgvBufDetalle.Columns(X).DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                            dgvBufDetalle.Columns(X).DefaultCellStyle.Format = "$ #,##0.00"
                        Else
                            dgvBufDetalle.Columns(X).DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleLeft
                        End If
                        Select Case X
                            Case 0
                                textEnc = "ELIM"
                                dgvBufDetalle.Columns(0).Width = 30
                            Case 1
                                textEnc = "ITEM"
                                dgvBufDetalle.Columns(1).Width = 30
                            Case 2
                                textEnc = "VALOR"
                                dgvBufDetalle.Columns(2).Width = 100
                            Case 3
                                textEnc = "NUMERO"
                                dgvBufDetalle.Columns(3).Width = 100
                            Case 4
                                textEnc = "FEC COBRO"
                                dgvBufDetalle.Columns(4).Width = 150
                            Case 5
                                textEnc = "LIBRADOR"
                                dgvBufDetalle.Columns(5).Width = 150
                            Case 6
                                textEnc = "BANCO"
                                dgvBufDetalle.Columns(6).Width = 100
                            Case 7
                                textEnc = "SUCURSAL"
                                dgvBufDetalle.Columns(7).Width = 100
                            Case 8
                                textEnc = "IMPORTE"
                                dgvBufDetalle.Columns(8).Width = 70
                            Case 9
                                textEnc = "OBSERVACIONES"
                                dgvBufDetalle.Columns(9).Width = 100
                        End Select
                        dgvBufDetalle.Columns(X).HeaderText = textEnc
                    Next

                End If
            End If

        Catch ex As MySqlException
            MsgBox("Error: Tabla Detalle no fue modificada !" & vbCrLf & vbCrLf & ex.ToString, vbCritical, "Servicio de Alertas")
            BDxxx()
        Finally
            BDxxx()
        End Try

    End Sub

    Private Sub frmCaja_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        Try
            Dim _Ver As New Mostrar
            Dim _Dt, _Dt1 As New DataTable
            Dim _Elim As New GrabaDatos

            _Dt = _Ver.verDetalleValoresRecVta()
            dgvBufDetalle.DataSource = _Dt
            dgvBufDetalle.Columns.Item("ObservValor").Visible = False

            Dim estiloEnc As New DataGridViewCellStyle()
            Dim textEnc As String = ""
            Dim X As Integer

            estiloEnc.Font = New Font(dgvBufDetalle.Font, FontStyle.Bold)
            dgvBufDetalle.ColumnHeadersDefaultCellStyle = estiloEnc
            dgvBufDetalle.ColumnHeadersDefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
            For X = 1 To 9
                If X = 1 Then
                    dgvBufDetalle.Columns(X).DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                ElseIf X = 4 Then
                    dgvBufDetalle.Columns(X).DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                ElseIf X = 8 Then
                    dgvBufDetalle.Columns(X).DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                    dgvBufDetalle.Columns(X).DefaultCellStyle.Format = "$ #,##0.00"
                Else
                    dgvBufDetalle.Columns(X).DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleLeft
                End If
                Select Case X
                    Case 0
                        textEnc = "ELIM"
                        dgvBufDetalle.Columns(0).Width = 30
                    Case 1
                        textEnc = "ITEM"
                        dgvBufDetalle.Columns(1).Width = 30
                    Case 2
                        textEnc = "VALOR"
                        dgvBufDetalle.Columns(2).Width = 100
                    Case 3
                        textEnc = "NUMERO"
                        dgvBufDetalle.Columns(3).Width = 100
                    Case 4
                        textEnc = "FEC COBRO"
                        dgvBufDetalle.Columns(4).Width = 150
                    Case 5
                        textEnc = "LIBRADOR"
                        dgvBufDetalle.Columns(5).Width = 150
                    Case 6
                        textEnc = "BANCO"
                        dgvBufDetalle.Columns(6).Width = 100
                    Case 7
                        textEnc = "SUCURSAL"
                        dgvBufDetalle.Columns(7).Width = 100
                    Case 8
                        textEnc = "IMPORTE"
                        dgvBufDetalle.Columns(8).Width = 70
                    Case 9
                        textEnc = "OBSERVACIONES"
                        dgvBufDetalle.Columns(9).Width = 100
                End Select
                dgvBufDetalle.Columns(X).HeaderText = textEnc
            Next

            _Dt1 = _Ver.verSistema(mdifrmppal.cdEmp)
            Dim _Row As DataRow = _Dt1.Rows(_Dt1.Rows.Count - 1)
            txtNroRecibo.Text = CStr(_Row("NroRecibo"))
            txtPtoVta.Text = CStr(_Row("PtoVta"))

            Me.Text = "EMISION DE RECIBOS DE VENTA - " & mdifrmppal.encForm
            txtCdEmp.Text = mdifrmppal.cdEmp
            lblFunValor.Text = "Nuevo"
            txtImporte.Text = Format(0, "$ #,##0.00")
            txtImpValor.Text = Format(0, "$ #,##0.00")
            btnNuevo.Select()
        Catch ex As Exception
            MsgBox("Error: Recibos de Venta no pueden cargarse !", vbInformation, "Servicio de Alertas")
        End Try
    End Sub

    Private Sub txtLibrador_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtLibrador.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            txtFecCobro.SelectionLength = Len(txtFecCobro.Text)
            txtFecCobro.Select()
        End If
    End Sub

    Private Sub ActualizaTotal()
        'Actualizo el DataGridView y sumo valores
        Dim _Ver As New Mostrar
        Dim _Dt As New DataTable
        Dim TotalValores As Double

        _Dt = _Ver.verDetalleValoresRecVta()
        dgvBufDetalle.DataSource = _Dt
        For Each row As DataGridViewRow In dgvBufDetalle.Rows
            TotalValores += Val(row.Cells(8).Value)
        Next
        txtTotVal.Text = Format(TotalValores, "$ #,##0.00")
    End Sub

    Private Sub btnModValor_Click(sender As Object, e As EventArgs) Handles btnModValor.Click
        Try
            If dgvBufDetalle.RowCount <> 0 Then
                lblFunValor.Text = "Modificar"
                lblidDetCaja.Text = dgvBufDetalle.SelectedCells.Item(1).Value
                txtValNum.Text = dgvBufDetalle.SelectedCells.Item(3).Value
                cbxTipoValor.Text = dgvBufDetalle.SelectedCells.Item(2).Value
                cbxBanco.Text = dgvBufDetalle.SelectedCells.Item(6).Value
                txtSucursal.Text = dgvBufDetalle.SelectedCells.Item(7).Value
                txtLibrador.Text = dgvBufDetalle.SelectedCells.Item(5).Value
                txtFecCobro.Text = Format(CDate(dgvBufDetalle.SelectedCells.Item(4).Value), "dd/MM/yyyy")
                txtImpValor.Text = Format(CDbl(dgvBufDetalle.SelectedCells.Item(8).Value), "$ #,##0.00")
                txtObsValor.Text = dgvBufDetalle.SelectedCells.Item(9).Value
                txtValNum.SelectionLength = Len(txtValNum.Text)
                txtValNum.Select()
            End If
        Catch ex As Exception
            MsgBox("Error: No se pueden cargar los datos para modificar !" & vbCrLf & vbCrLf & ex.ToString, vbExclamation, "Servicio de Alertas")
            btnModValor.Select()
        End Try
    End Sub

    Private Sub btnCancelarValor_Click(sender As Object, e As EventArgs) Handles btnCancelarValor.Click
        LimpiarValor()
        txtValNum.Select()
    End Sub

    Private Sub dgvBufDetalle_CellContentClick(sender As Object, e As DataGridViewCellEventArgs) Handles dgvBufDetalle.CellContentClick
        If e.ColumnIndex = Me.dgvBufDetalle.Columns.Item("ElimBuff").Index Then
            Dim celSel As DataGridViewCheckBoxCell = Me.dgvBufDetalle.Rows(e.RowIndex).Cells("ElimBuff")
            celSel.Value = Not celSel.Value
        End If
    End Sub

    Private Sub btnEliminarValor_Click(sender As Object, e As EventArgs) Handles btnEliminarValor.Click
        Dim resP As DialogResult
        Dim _Elim As New GrabaDatos

        resP = MessageBox.Show("Elimar Items Selcionados!?", "Servico de Alertas", MessageBoxButtons.OKCancel, MessageBoxIcon.Question)

        If resP = Windows.Forms.DialogResult.OK Then
            Try
                For Each row As DataGridViewRow In dgvBufDetalle.Rows
                    Dim seL As Boolean = Convert.ToBoolean(row.Cells("ElimBuff").Value)

                    If seL = True Then
                        Dim clElim As Integer = Convert.ToInt32(row.Cells("IdReciboDetalle").Value)
                        _Elim.Grabar("Recibo Venta", "NoImagen", "eliBuffDetalleRecVta", clElim)
                    End If
                Next

                ActualizaTotal()
                LimpiarValor()
                txtValNum.Select()
            Catch ex As MySqlException
                MsgBox("Error al Eliminar Items de Valores !" & vbCrLf & vbCrLf & ex.ToString, vbCritical, "Servicio de Alertas")
            End Try
        End If
    End Sub

    Private Sub btnValEnCartera_Click(sender As Object, e As EventArgs)
        If cbxTipoMov.Text = "Ingreso" Then
            MsgBox("Error: No puede seleccionar valores si elige Ingreso en 'Tipo Movimiento' !", vbInformation, "Servicio de Alertas")
            cbxTipoMov.SelectionLength = Len(cbxTipoMov.Text)
            cbxTipoMov.Select()
        Else
            frmChqEnCartera.ShowDialog()
        End If
    End Sub

    Private Sub txtImporte_Validated(sender As Object, e As EventArgs) Handles txtImporte.Validated
        If Not IsNumeric(txtImporte.Text) Then
            txtImporte.Text = Format(0, "$ #,##0.00")
            txtImporte.Select()
        Else
            txtImporte.Text = Format(CDbl(txtImporte.Text), "$ #,##0.00")
            txtObserv.SelectionLength = Len(txtObserv.Text)
            txtObserv.Select()
        End If
    End Sub

    Private Sub txtImpTexto_KeyPress(sender As Object, e As KeyPressEventArgs) Handles txtImpTexto.KeyPress
        If Asc(e.KeyChar) = Keys.Enter Then
            e.Handled = True
            txtValNum.SelectionLength = Len(txtValNum.Text)
            txtValNum.Select()
        End If
    End Sub

End Class